<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
                        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 네임스페이스(사용영역) 설정 -->
<mapper namespace="com.euishoe.products">

	<resultMap type="com.euishoe.products.dto.Product" id="Product">
		<result property="productCount" column="product_count"/>
    	<result property="jacketCode" column="JACKET_CODE"/>
    	<result property="pantsCode" column="PANTS_CODE"/>
    	<result property="productCode" column="PRODUCT_CODE"/>
    	<result property="productNum" column="PRODUCT_NUM"/>
	</resultMap>
	<!-- 프로덕트 검색 기능 -->
	<select id="newProductList" resultType="map">
	<![CDATA[
		SELECT 	   p.product_num "productNum",  
			       p.product_list_num "productListNum", 
			       p.product_name "productName", 
			       p.product_cost "productCost", 
			       p.product_price "productPrice", 
			       p.product_brief_information "productBriefInfomation", 
			       p.product_manufacturer "productManufacturer", 
			       p.product_release_date "productReleaseDate", 
			       p.product_origin "productOrigin", 
			       p.product_list_price "productListPrice",
			       p.color_code "colorCode", 
			       p.product_hitcount "productHitcount", 
			       p.product_body "productBody", 
			       p.product_shoulder "productShoulder", 
			       p.product_arm "productArm", 
			       p.product_leg "productLeg", 
			       p.product_season "productSeason", 
			       p.product_fabric "productFabric", 
			       p.product_tpo "productTpo",
			       m.image_ref "imageRef"
		FROM   product_infos p 
		       join images m 
		         ON ( m.product_num = p.product_num ) 
		WHERE  p.product_num IN((SELECT product_num 
		                         FROM   (SELECT product_num, 
		                                        product_release_date 
		                                 FROM   product_infos 
		                                 WHERE  product_list_num IS NOT NULL 
		                                 ORDER  BY product_release_date DESC) 
		                         WHERE  ROWNUM <= 4))
	]]>
	</select>

	<select id="hitProductList" resultType="map">
	<![CDATA[
		SELECT 	   p.product_num "productNum",  
			       p.product_list_num "productListNum", 
			       p.product_name "productName", 
			       p.product_cost "productCost", 
			       p.product_price "productPrice", 
			       p.product_brief_information "productBriefInfomation", 
			       p.product_manufacturer "productManufacturer", 
			       p.product_release_date "productReleaseDate", 
			       p.product_origin "productOrigin", 
			       p.product_list_price "productListPrice",
			       p.color_code "colorCode", 
			       p.product_hitcount "productHitcount", 
			       p.product_body "productBody", 
			       p.product_shoulder "productShoulder", 
			       p.product_arm "productArm", 
			       p.product_leg "productLeg", 
			       p.product_season "productSeason", 
			       p.product_fabric "productFabric", 
			       p.product_tpo "productTpo",
			       m.image_ref "imageRef"
		FROM   product_infos p 
		       join images m 
		         ON ( m.product_num = p.product_num ) 
		WHERE  p.product_num IN (SELECT product_num 
		                         FROM   (SELECT product_num, 
		                                        product_hitcount 
		                                 FROM   product_infos 
		                                 WHERE  product_list_num IS NOT NULL 
		                                 ORDER  BY product_hitcount DESC) 
		                         WHERE  ROWNUM <= 4)	
	]]>
	</select>
	
	<select id="selectAll" resultType="map">
			SELECT p.product_num "productNum",  
			       p.product_list_num "productListNum", 
			       p.product_name "productName", 
			       p.product_cost "productCost", 
			       p.product_price "productPrice", 
			       p.product_brief_information "productBriefInfomation", 
			       p.product_manufacturer "productManufacturer", 
			       p.product_release_date "productReleaseDate", 
			       p.product_origin "productOrigin", 
			       p.product_list_price "productListPrice",
			       p.color_code "colorCode", 
			       p.product_hitcount "productHitcount", 
			       p.product_body "productBody", 
			       p.product_shoulder "productShoulder", 
			       p.product_arm "productArm", 
			       p.product_leg "productLeg", 
			       p.product_season "productSeason", 
			       p.product_fabric "productFabric", 
			       p.product_tpo "productTpo",
			       m.image_ref "imageRef"
			FROM product_infos p 
		       		join images m 
		         ON ( m.product_num = p.product_num )
	</select>
	
	<select id="selectAllById" parameterType="Integer" resultType="map">
			SELECT p.product_num "productNum",  
			       p.product_list_num "productListNum", 
			       p.product_name "productName", 
			       p.product_cost "productCost", 
			       p.product_price "productPrice", 
			       p.product_brief_information "productBriefInfomation", 
			       p.product_manufacturer "productManufacturer", 
			       p.product_release_date "productReleaseDate", 
			       p.product_origin "productOrigin", 
			       p.product_list_price "productListPrice",
			       p.color_code "colorCode", 
			       p.product_hitcount "productHitcount", 
			       p.product_body "productBody", 
			       p.product_shoulder "productShoulder", 
			       p.product_arm "productArm", 
			       p.product_leg "productLeg", 
			       p.product_season "productSeason", 
			       p.product_fabric "productFabric", 
			       p.product_tpo "productTpo",
			       m.image_ref "imageRef"
			FROM product_infos p 
		       		join images m 
		         ON ( m.product_num = p.product_num )
		    WHERE p.product_num = #{productNum}     
	</select>
	
	<select id="selectImageRefByProductNum" parameterType="String" resultType="String">
			SELECT m.image_ref "imageRef"
			 FROM product_infos p 
			    join images m 
			      ON ( m.product_num = p.product_num )
			WHERE  p.product_num = #{productNum}
	</select>
	
	<select id="selectProductInfoByProductNum" parameterType="String" resultType="ProductInfo">
			SELECT product_num "productNum",  
			       product_list_num "productListNum", 
			       product_name "productName", 
			       product_cost "productCost", 
			       product_price "productPrice", 
			       product_brief_information "productBriefInfomation", 
			       product_manufacturer "productManufacturer", 
			       product_release_date "productReleaseDate", 
			       product_origin "productOrigin", 
			       product_list_price "productListPrice",
			       color_code "colorCode", 
			       product_hitcount "productHitcount", 
			       product_body "productBody", 
			       product_shoulder "productShoulder", 
			       product_arm "productArm", 
			       product_leg "productLeg", 
			       product_season "productSeason", 
			       product_fabric "productFabric", 
			       product_tpo "productTpo"
			FROM   product_infos
			WHERE  product_num = #{productNum}
	</select>
	
	
	<select id="filter" parameterType="FilterParam" resultType="map">
			SELECT pi.product_num "productNum", 
                       product_list_num "productListNum", 
                       product_name "productName", 
                       product_list_price "productListPrice", 
                       product_brief_information "productBriefInfomation", 
                       product_manufacturer "productManufacturer",
                       product_season "productSeason",
                       product_release_date "productReleaseDate", 
                       product_origin "productOrigin", 
                       color_code "colorCode", 
                       product_hitcount "productHitcount",
                       product_tpo "productTpo",
                       product_body "productBody",
                       product_shoulder "productShoulder",
                       product_arm "productArm",
            		   product_leg "productLeg",
            		   product_fabric "productFabric",
                       m.image_ref "imageRef",
                       rs.avg_score "starScore" 
                FROM   product_infos pi 
                       left outer join (SELECT p.product_num, Avg(r.review_score) avg_score 
                                          FROM   reviews r join products p 
                                                   ON r.product_num = p.product_num 
                                          GROUP  BY p.product_num) rs 
                                      ON pi.product_num = rs.product_num 
                         join images m ON ( m.product_num = pi.product_num)
                where  product_list_num is not null and m.image_ref like '%main%'
                <if test="lowPrice != null">
                	<choose>
                 		<when test="highPrice == null">
                 			and product_list_price >= #{lowPrice}
                 		</when>
                 		<when test="highPrice != null">
                 			and product_list_price between #{lowPrice} and #{highPrice}
                 		</when>
                	</choose>
                </if>
                <if test="tpo != null">
                	and product_tpo = #{tpo}
                </if>
                <if test="season != null">
                	and product_season = #{season}
                </if>
                <if test="color != null">
                	and color_code = #{color}
                </if>
                <if test="shoulderType != 0">
                	and product_shoulder = #{shoulderType}
                </if>
                <if test="armType != 0">
                	and product_arm = #{armType}
                </if>
                <if test="legType != 0">
                	and product_leg = #{legType}
                </if>
                <if test="bodyType != 0">
                	and product_body = #{bodyType}
                </if>
                <if test="fabric != null">
                	and product_fabric = #{fabric}
                </if>
                 <if test="orderByPrice != null">
                 	order by product_list_price #{orderByPrice}
                 </if>
                 <if test="orderByHitcount != null">
                 	order by product_hitcount #{orderByHitcount}
                 </if>
                 <if test="orderByStar != null">
                 	order by star_score #{orderByStar}
                 </if>
	</select>

	<insert id="create" parameterType="com.euishoe.products.dto.Product">
		INSERT INTO products 
		VALUES     ( CONCAT(#{PRODUCT_CODE},'#',PRODUCT_SEQ.nextval),  
		             #{JACKET_CODE}, 
		             #{PANTS_CODE}, 
		             #{PRODUCT_NUM}, 
		             #{product_count}) 		
	</insert>
	
    <insert id="createOne" parameterType="map">
		INSERT INTO products(PRODUCT_CODE,JACKET_CODE,PANTS_CODE,PRODUCT_NUM,PRODUCT_COUNT) 
		VALUES     ( CONCAT(CONCAT(#{PRODUCT_CODE},'#'),PRODUCT_SEQ.nextval),  
		             #{JACKET_CODE}, 
		             #{PANTS_CODE}, 
		             #{PRODUCT_NUM}, 
		             #{PRODUCT_COUNT}) 		
	</insert>
	<select id ="maxProductCodeNum" resultType="int">
		select max(product_code_num)
		from products
	</select>
    
    <update id="update" parameterType="map">
        update products set PRODUCT_COUNT = #{productCount} where PRODUCT_CODE LIKE #{productCode}
    </update>
    
    <update id="updatePants" parameterType="map">
	    update pants
		set pants_count = #{pantsCount}
		where pants_code = #{pantsCode}
	</update>
	
	<update id="updateJackets" parameterType="map">
	    update jackets
		set jacket_count = #{jacketCount}
		where jacket_code = #{jacketCode}
	</update>
	
</mapper>